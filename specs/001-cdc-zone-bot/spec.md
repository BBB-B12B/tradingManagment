# สเปคฟีเจอร์: BinanceTH CDC Zone Bot

**สาขาฟีเจอร์**: `[001-cdc-zone-bot]`  
**วันที่สร้าง**: 2025-11-24  
**สถานะ**: Draft  
**อินพุต**: เตรียมระบบช่วยเทรด/อัตโนมัติบน BinanceTH โดยใช้ระบบ “CDC สู่โซน” แบบ 3 ชั้น (ทิศสีเขียว-แดง, สัญญาณนำหน้า, รูปแบบราคา W) และสรุปกฎแท้จริง 4 ข้อให้ Bot แปลงเป็นเงื่อนไขโปรแกรม

## สถานการณ์ผู้ใช้และการทดสอบ *(บังคับ)*

### User Story 1 - ตั้งค่า CDC Zone Bot (Priority: P1)

ในฐานะเทรดเดอร์ที่ต้องการให้ระบบช่วยเข้าออเดอร์ ฉันต้องสามารถเลือกคู่เหรียญ BinanceTH, กำหนด Timeframe ที่จะคำนวณ CDC, กำหนดวงเงินต่อเทรดไม่เกิน 1% ของพอร์ต และเปิด/ปิดเงื่อนไขเสริม (เช่น ตรวจจับ W-shape, สัญญาณนำหน้า) เพื่อควบคุมบอทให้ตรงกลยุทธ์

**เหตุผลของลำดับความสำคัญ**: การตั้งค่าที่ชัดเจนเป็นพื้นฐานก่อนบอททำงานจริง และเชื่อมกับหลักการรักษาทุนของโปรเจกต์

**การทดสอบอิสระ**: ให้ผู้ใช้กำหนดค่าจริงบนสภาพแวดล้อมจำลองและตรวจว่า config ถูกบันทึก-แสดงผลครบทุกฟิลด์โดยไม่ส่งคำสั่งเทรด

**Acceptance Scenario**:

1. **Given** ผู้ใช้เลือกคู่ BTC/THB และ Timeframe 1H, **When** ป้อนเงินต่อเทรด 1% และเปิดฟิลเตอร์ W-shape, **Then** ระบบต้องแสดงค่าที่บันทึกพร้อมตัวอย่างปัจจัยที่บอทจะใช้
2. **Given** ผู้ใช้อัปเดตค่า risk เป็น 0.8%, **When** บันทึก, **Then** ระบบต้องตรวจ validation ไม่เกิน 1% และบันทึกสำเร็จ

---

### User Story 2 - ตรวจสัญญาณและอนุมัติคำสั่ง (Priority: P1)

ในฐานะผู้คุมระบบ ฉันต้องเห็นแดชบอร์ดที่บอกสถานะ CDC ปัจจุบัน (เขียว/แดง), ตรวจว่ามี “แดงนำหน้า” ล่าสุดหรือไม่ตาม Multi Timeframe (เช่น Week ยังเขียวแต่ Day/1H ย่อลงแดง), มีแพตเทิร์น W ชัดเจน, มีสัญญาณนำหน้า เช่น แท่งกลับตัวหรือโมเมนตัมอ่อนลง และต้องรู้ด้วยว่า ณ จุดตัดกลับตัวล่าสุด ระบบได้เข้าซื้อไปแล้วหรือยัง เพื่อจะได้ตัดสินใจถือรอหรือหาจังหวะใหม่ ก่อนจะอนุมัติให้บอทเข้าสถานะหรือปล่อยบอทให้ทำอัตโนมัติ

**เหตุผลของลำดับความสำคัญ**: เป็นหัวใจของระบบ CDC สู่โซน ถ้าสัญญาณวัดไม่ได้ บอทจะเข้าผิดบริบท

**การทดสอบอิสระ**: จำลองข้อมูลตลาดย้อนหลังที่มี CDC เขียวหลังแดงพร้อม W-shape แล้วตรวจว่าแดชบอร์ดไฮไลต์ครบทั้ง 3 ชั้นก่อนเปิดปุ่ม “อนุมัติซื้อ”

**Acceptance Scenario**:

1. **Given** ข้อมูลล่าสุดมีแท่งแดงก่อนหน้าและราคาสร้าง Higher Low พร้อมบันทึกว่ายัง “ไม่มีสถานะถืออยู่”, **When** CDC เปลี่ยนเป็นเขียว, **Then** แดชบอร์ดต้องไฮไลต์ครบ 4 กฎและเปิดทางเลือก “วางออเดอร์อัตโนมัติ”
2. **Given** CDC เป็นเขียวโดยไม่มีแดงนำหน้าใน 5 แท่งหรือ Week กลับเป็นแดง, **When** ผู้ใช้เปิดหน้าแดชบอร์ด, **Then** ระบบต้องแจ้งเตือนว่าขาดเงื่อนไข “แดงนำหน้า” และไม่ให้บอทส่งคำสั่ง
3. **Given** ระบบแสดงว่าคู่เหรียญหนึ่งยังถือสถานะมาจากจุดตัดกลับตัวก่อนหน้า, **When** CDC ยังเขียวและยังไม่มีแท่งแดงใหม่, **Then** ต้องขึ้นข้อความ “ถืออยู่ รอแดงขาย” และบล็อกการหาจังหวะซื้อซ้ำ

---

### User Story 3 - ส่งคำสั่ง BinanceTH แบบปลอดภัย (Priority: P2)

ในฐานะผู้ดูแล ฉันต้องให้ระบบวางออเดอร์ใน BinanceTH (บัญชี BinanceTH Spot) โดยอ้างอิงการจัดสรรทุน ≤1% ต่อดีล, ทำ Split order ได้ (เช่น 2 ครั้งภายในโควตาเดียว), ตั้ง Stop-loss/Take-profit ตาม CDC และบันทึกทุกคำสั่งพร้อมเหตุผล (กฎที่เข้า), เพื่อให้การซื้อขายอัตโนมัติยังมีร่องรอยตรวจสอบและลดความเสี่ยง live trade

**เหตุผลของลำดับความสำคัญ**: หลังสัญญาณพร้อม ระบบต้องวางออเดอร์จริงและต้องตอบโจทย์ธรรมาภิบาลของโปรเจกต์

**การทดสอบอิสระ**: ใช้ Binance TH Test/Sandbox ส่งคำสั่งจำลองเมื่อครบ 4 กฎ ตรวจว่าไฟล์บันทึกและแจ้งเตือนเกิดขึ้นแม้ API ล่าช้า

**Acceptance Scenario**:

1. **Given** User Story 2 ให้สัญญาณพร้อมและระบบยืนยันว่า “ยังไม่มีสถานะถืออยู่”, **When** บอทส่งคำสั่งซื้อ 0.8% พอร์ต, **Then** ต้องมี stop-loss อ้างอิง Low ล่าสุด และสร้างบันทึกออเดอร์พร้อมเลข CDC bar
2. **Given** Binance API ส่ง error, **When** บอทพยายามส่งคำสั่ง, **Then** ระบบต้อง retry ตามนโยบายและถ้าเกินโควตาต้องปิดสัญญาณพร้อมเตือนผู้ใช้
3. **Given** ระบบถือสถานะอยู่แล้วและเกิดแท่งแดงใหม่ตามกฎ, **When** บอทตรวจพบ, **Then** ต้องสร้าง order plan เพื่อขาย/ลดสถานะและรีเซ็ต state เพื่อรอรอบซื้อใหม่
4. **Given** ผู้ใช้เปิด option “structural stop-loss” ที่อ้าง W-low, **When** ราคาหลุดระดับ SL buffer ที่ตั้งไว้, **Then** ระบบต้องส่งคำสั่งขายทันทีพร้อมระบุเหตุผล `STRUCTURAL_SL`

---

### User Story 4 - วิเคราะห์ผลและปรับแต่ง (Priority: P3)

ในฐานะผู้วางกลยุทธ์ ฉันต้องเห็นรายงานและแดชบอร์ดหลังการเทรดที่บอกว่าแต่ละดีลเข้าจากกฎข้อไหน, มีแดงนำหน้ากี่แท่ง, เกิด W-shape หรือไม่, ใช้สัญญาณนำหน้าแบบใด และผลกำไร/ขาดทุน โดยข้อมูลต้องมาจากฐานข้อมูลคำสั่งซื้อขายที่เก็บเวลาซื้อ-ขาย สถานะ และผลตอบแทนจริง เพื่อปรับ threshold และพัฒนารุ่นถัดไปอย่างมีหลักฐาน

**เหตุผลของลำดับความสำคัญ**: ใช้ประเมินว่ากฎ 4 ข้อให้ผลตามที่ตั้งใจหรือควรปรับ

**การทดสอบอิสระ**: หลังจบชุดเทรด 10 ดีลใน sandbox ให้ระบบสร้างรายงานและกรองดีลที่ขาดกฎข้อใดข้อหนึ่ง

**Acceptance Scenario**:

1. **Given** ระบบบันทึก 3 ดีลในฐานข้อมูลคำสั่ง, **When** ผู้ใช้เปิดรายงาน, **Then** แต่ละดีลต้องมีแผง “ผ่านกฎ 1-4 หรือไม่” เวลาซื้อ/ขาย และตัวเลขผลตอบแทน
2. **Given** มีดีลผิดเพราะไม่มี W-shape, **When** ดูรายงาน, **Then** ต้องแสดงธงเตือนและเสนอให้ปิดออโต้สำหรับคู่ดังกล่าว

---

### กรณีขอบ

- เกิด CDC เขียวแต่เป็น V-shape ไม่มีการพักฐาน → ระบบต้องห้ามซื้อแม้สีจะตรง
- ตลาดขาดข้อมูล (websocket หลุด) → บอทต้องหยุดและแจ้งเตือน
- ข้อมูลแดงนำหน้าเกินระยะเวลาที่กำหนด (เช่น >10 แท่ง) → ต้องรีเซ็ตและรอสัญญาณใหม่
- Binance ส่งออเดอร์บางส่วน (partial fill) → ต้องอัปเดต exposure และคงการคำนวณ 1% ตามที่เหลือ
- หลายคู่เหรียญพร้อมกัน → ต้องจัดลำดับตาม priority และไม่รวม exposure เกินทุนรวม

## การจัดแนว Risk & Validation *(บังคับตามรัฐธรรมนูญ)*

- **Risk Guardrails**: จำกัดเงินต่อคำสั่ง ≤1% ของพอร์ต, เปิด circuit breaker รายวัน 3% และ Drawdown 5% สำหรับบอท CDC, ทุก config ต้องผ่าน validation
- **Indicator Provenance**: CDC คำนวณจากข้อมูล Candle 1H BinanceTH, บันทึกเวอร์ชันสูตร, แหล่งข้อมูล, Timezone และเก็บ snapshot เมื่อส่งคำสั่ง
- **Validation Plan**: ต้อง Backtest อย่างน้อย 3 ช่วงตลาด (ขึ้นแรง, ลงแรง, sideway) + Paper trade 2 สัปดาห์เพื่อพิสูจน์ว่ากฎ 4 ข้อคัดกรองสัญญาณหลอกได้; ต้องเก็บ log การผ่าน/ไม่ผ่านแต่ละกฎ
- **Environment Segregation**: วิ่งได้เฉพาะ Research (backtest), Simulation (paper) และ Orchestrator live; live key อยู่ที่ orchestrator เท่านั้นและต้องส่งคำสั่งผ่าน control plane ที่มี approval
- **Observability Hooks**: บันทึก metric เวลา latency ของสัญญาณ, จำนวนกฎที่ผ่าน, จำนวนออเดอร์ที่ถูกบล็อก, สร้าง Alert เมื่อการตรวจสัญญาณล้มเหลวหรือ circuit breaker ทำงาน, และต้องมีปุ่ม kill switch ปิดเฉพาะ CDC bot

## ความต้องการ *(บังคับ)*

### Functional Requirements

- **FR-001**: ระบบต้องให้ผู้ใช้กำหนดค่า bot configuration ต่อคู่เหรียญ BinanceTH (timeframe, วงเงินต่อดีล, toggle W-shape, toggle leading signal) และบันทึกข้อมูลพร้อมตรวจ validation ความเสี่ยง
- **FR-002**: ระบบต้องดึงข้อมูล CDC/แท่งเทียนแบบต่อเนื่องและวิเคราะห์กฎ 3 ชั้น (สี, แดงนำหน้า, รูปแบบราคา) พร้อมตีความสัญญาณนำหน้า เช่น loss of momentum, Higher Low, หรือ indicator เสริม โดยแสดงผลเป็น Boolean (ผ่าน/ไม่ผ่าน) ไม่ใช่คะแนน
- **FR-003**: ระบบต้องบล็อกการส่งคำสั่งเมื่อ CDC เป็นเขียวโดยขาดเงื่อนไขใด ๆ จาก 4 กฎ และแสดงข้อความเตือนเฉพาะข้อที่ไม่ผ่าน
- **FR-004**: เมื่อครบ 4 กฎและผู้ใช้อนุมัติ (หรือเปิดโหมดออโต้) ระบบต้องสร้าง order plan ที่คำนวณจำนวนซื้อ ≤1% ของทุนที่เหลือ, ระบุ stop-loss จาก Low ล่าสุด, และ take-profit ตาม CDC zone ถัดไป ก่อนคิวส่ง BinanceTH โดยต้องตรวจว่า “ยังไม่มีสถานะถืออยู่” ก่อนเสมอ
- **FR-005**: ระบบต้องบันทึกการประเมินแต่ละกฎ, บันทึก order detail (timestamp, pair, ขนาด, stop-loss, เหตุผล), เก็บผลการปิดดีล (ราคา, กำไร/ขาดทุน) ลงฐานข้อมูล order history และเผยแพร่ในรายงาน/แดชบอร์ดหลังจบดีลทุกครั้ง
- **FR-006**: ระบบต้องจัดการข้อผิดพลาด Binance API (timeout, partial fill, reject) ด้วยการ retry ตาม policy, อัปเดตสถานะคำสั่ง และปิดบอทหาก retry เกินเกณฑ์
- **FR-007**: ระบบต้องสร้างแดชบอร์ดรวมที่แสดงสถานะปัจจุบันของทุกคู่ (สี CDC, ระยะเวลาตั้งแต่แดงล่าสุด, การวัด W-shape) พร้อมให้ผู้ใช้งานกดหยุด/ต่อบอททันที
- **FR-008**: ระบบต้องเก็บ state ว่าแต่ละคู่ “ถืออยู่/ว่าง” จากจุดตัดกลับตัวล่าสุด เพื่อป้องกันการซื้อซ้ำ และเมื่อเกิดแท่งแดงครบตามกฎต้องแนะนำ/สร้างคำสั่งขายอัตโนมัติ รวมถึงรีเซ็ต state เพื่อรอรอบซื้อถัดไป
- **FR-009**: ระบบต้องจัดเก็บ OrderHistoryDB บนโครงสร้างข้อมูลของ Cloudflare (เช่น Database/Key-Value ที่ Cloudflare ให้บริการ) โดยต้องรองรับการอ่าน/เขียนแบบทนทานสำหรับรายงาน กำหนด retention ขั้นต่ำ 1 ปี และเข้าถึงผ่าน API ที่มีการอนุมัติจาก control plane
- **FR-010**: ระบบต้องประเมินเงื่อนไข “แดงนำหน้า” แบบ Multi Timeframe โดยค่าเริ่มต้นใช้ HTF = Week, LTF = TF เข้า (เช่น 1H) พร้อมพารามิเตอร์ `lead_red_min_bars_LTF` และ `lead_red_max_bars_LTF` เพื่อจำกัดช่วงที่ยอมรับได้
- **FR-011**: ระบบต้องคำนวณ “สัญญาณนำหน้า” แบบ Boolean ตามเกณฑ์ momentum flip (MACD Histogram เปลี่ยนจากลบเป็นบวกภายใน `leading_momentum_lookback` แท่ง) และ Higher Low (swing low สองจุดภายใน window กำหนด, ความต่างขั้นต่ำ `higher_low_min_diff_pct`, ระยะห่างไม่เกิน `higher_low_max_bars_between`)
- **FR-012**: ระบบต้องจำแนกรูปแบบราคาเป็น W/V/NONE โดยพิจารณา swing low/high ในหน้าต่าง `w_window_bars`, ตรวจเงื่อนไข W-shape (เช่น ขาขึ้นกลาง, higher low) และตรวจ V-shape เมื่อขาลง-ดีดสั้น (`v_max_drop_bars`, `v_max_recovery_bars`, % การดิ่ง/ดีดอย่างน้อย) เพื่อใช้เป็นส่วนหนึ่งของกฎ 4 ข้อ
- **FR-013**: ระบบต้องรองรับตัวเลือก “structural stop-loss” ใน TradingConfiguration (เปิด/ปิด, แหล่งอ้าง SL, buffer %) เพื่อให้ผู้ใช้เลือกว่าจะให้ Cutloss ตาม CDC อย่างเดียว หรือเพิ่ม Stop-loss ตามโครงสร้าง W-low

### เอนทิตีสำคัญ

- **TradingConfiguration**: เก็บคู่เหรียญ, timeframe, วงเงิน/ดีล, toggle เงื่อนไข W-shape และ leading signal, ค่า risk breaker รายวัน
- **IndicatorSnapshot**: เก็บข้อมูลแท่ง, สี CDC, คะแนน W-shape, ตัวชี้วัดโมเมนตัม, เวลาประทับ, References ใช้ประเมินกฎ 1-4
- **OrderPlan & ExecutionLog**: แสดงจำนวนที่จะซื้อ, ราคากลยุทธ์, stop-loss/take-profit, เหตุผลผ่านกฎ พร้อม log การส่ง/ผลลัพธ์จาก BinanceTH
- **OrderHistoryDB**: ฐานข้อมูลคำสั่งที่เก็บเวลาซื้อ-ขาย, ราคาจริง, ขนาด, ผลกำไร/ขาดทุน และการเชื่อมโยงกับกฎที่ผ่าน เพื่อสร้างแดชบอร์ดและรายงาน
- **PositionState**: บันทึกว่าคู่เหรียญนั้นถืออยู่หรือไม่, จุดตัดกลับตัวล่าสุด, เงื่อนไขที่จะขาย (แท่งแดงใหม่, breaker, structural SL) และ timestamp ที่ใช้รีเซ็ตรอบใหม่
- **PatternClassification**: เก็บผลการคำนวณ pattern (W/V/NONE), จุด swing ที่ใช้, พารามิเตอร์ window เพื่อให้ตรวจสอบย้อนหลังได้

## นิยามเงื่อนไขหลัก (เชิงตัวเลขเพื่อใช้ใน Bot)

- **แดงนำหน้า (Leading Red)**: ใช้ 2 Timeframe (HTF = Week, LTF = TF ซื้อ). ต้องมี `color_HTF == GREEN` และก่อนแท่ง LTF ปัจจุบันที่เป็น GREEN ต้องพบแท่ง RED ในช่วง `[lead_red_min_bars_LTF, lead_red_max_bars_LTF]`. หาก HTF เปลี่ยนเป็นแดงถือว่าบริบท invalid ต้องรีเซ็ต.
- **สัญญาณนำหน้า (Leading Signal)**: boolean = `momentum_flip AND higher_low`. Momentum flip ใช้ MACD Histogram ที่กลับจากลบเป็นบวกภายใน `leading_momentum_lookback` แท่งล่าสุด. Higher low ใช้ swing low 2 จุด (fractal window 2) ภายในขอบเขต `swing_lookback_for_low`, ต้องมีความต่างขั้นต่ำ `higher_low_min_diff_pct` และเวลาห่างไม่เกิน `higher_low_max_bars_between`.
- **W-shape**: ตรวจในหน้าต่าง `w_window_bars` โดยต้องพบ swing low 2 จุด (L1, L2) และ swing high ตรงกลาง H ที่สูงกว่า low1 อย่างน้อย `w_mid_high_min_diff_pct`, แต่ละขามีความยาวอยู่ระหว่าง `w_leg_min_bars` ถึง `w_leg_max_bars`, และ low2 สูงกว่า/เท่ากับ low1 (ตั้งค่า `w_min_higher_low_pct`). ถ้าไม่ผ่านและพบรูปแบบลงเร็วเด้งเร็วตามเงื่อนไข `v_window_bars`, `v_max_drop_bars`, `v_max_recovery_bars`, `v_min_drop_pct`, `v_min_recovery_pct` ให้จัดเป็น V-shape เพื่อบล็อกการซื้อ.
- **กฎขาย (Exit Rules)**: Core rule = หาก CDC เปลี่ยนเป็นแดงบน TF เข้าเมื่อถือสถานะ ต้องขาย (`CDC_RED_EXIT`). Risk extension = หากเปิด option structural SL ให้ตั้ง SL จาก W-low หรือตาม swing low ที่ config ระบุ พร้อม buffer `structural_sl_buffer_pct`; หากราคาลงถึงจุดนั้นให้ขายทันที (`STRUCTURAL_SL`). รายงานต้องระบุเหตุผลการออกแต่ละครั้ง.

## เกณฑ์ความสำเร็จ *(บังคับ)*

### ตัวชี้วัดที่วัดได้

- **SC-001**: ผู้ใช้อย่างน้อย 90% สามารถตั้งค่าบอทครบทุกฟิลด์ภายใน 5 นาทีโดยไม่มี validation error
- **SC-002**: 100% ของคำสั่งที่ส่งต้องผ่านการตรวจครบทั้ง 4 กฎและถูกบันทึกเหตุผล ไม่พบคำสั่งที่ขาดกฎในรายงาน audit
- **SC-003**: ระบบสามารถตรวจจับและบล็อกสัญญาณเขียวผิด (ไม่มีแดงนำหน้า) ได้อย่างน้อย 95% ระหว่างช่วง paper trade 2 สัปดาห์
- **SC-004**: รายงานผลหลังการเทรดพร้อมสถิติแต่ละกฎต้องพร้อมภายใน 5 นาทีหลังคำสั่งปิด และทีมกลยุทธ์สามารถดาวน์โหลดในรูปแบบ CSV/PDF ได้
- **SC-005**: ไม่มีเหตุการณ์ circuit breaker ทำงานโดยไม่แจ้งเตือนผู้ใช้ล่วงหน้า (100% ของกรณี breaker ต้องส่ง alert ภายใน 1 นาที)

## สมมติฐานและข้อจำกัด

- ใช้ข้อมูล BinanceTH Spot 1H เป็นค่าเริ่มต้น (ผู้ใช้สามารถขยายในอนาคต)
- ระบบจะเริ่มในโหมด semi-auto (ต้องอนุมัติ) เพื่อให้ผ่านการตรวจสอบก่อนเปิด fully auto
- วงเงินสูงสุดต่อดีลและ breaker สามารถตั้งต่ำกว่าเกณฑ์เริ่มต้น แต่สูงกว่าไม่ได้
- โครงสร้าง OrderHistoryDB และ state ต่าง ๆ จะโฮสต์บนบริการ Cloudflare (เช่น D1, Durable Objects หรือ KV) เพื่อให้ได้ความทนทานและ latency ต่ำ พร้อมระบบสิทธิ์จาก control plane
- ค่าเริ่มต้นของพารามิเตอร์ (เช่น `lead_red_max_bars_LTF = 20`, `leading_momentum_lookback = 3`, `higher_low_max_bars_between = 20`, `w_window_bars = 30`) สามารถปรับได้ผ่าน config แต่สเปคนี้ถือว่าใช้ค่า defaults ดังกล่าว
